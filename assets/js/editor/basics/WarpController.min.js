angular.module("ImageEditor").controller("WarpController",function(a,e,r){function t(){var a=e.fabric;c(),a.on("mouse:down",i),a.on("mouse:move",f),a.on("mouse:up",l)}function n(){var a=e.fabric;a.off("mouse:down",i),a.off("mouse:move",f),a.off("mouse:up",l)}function c(){var a=e.currentImage();a&&(d={left:a.left,top:a.top,scaleX:a.scaleX,scaleY:a.scaleY,angle:a.angle})}function o(){var a=e.currentImage();a&&d&&(a.set(d),e.fabric.renderAll())}function i(a){g=!0;var r=e.fabric.getPointer(a.e);s(r.x,r.y)}function f(a){if(g){var r=e.fabric.getPointer(a.e);s(r.x,r.y)}}function l(a){g=!1}function s(r,t){var n=e.currentImage();if(n){var c=a.brushSize,o=a.brushStrength/100;e.fabric.forEachObject(function(e){if(e===n)switch(a.warpMode){case"push":u(e,r,t,c,o);break;case"pull":p(e,r,t,c,o);break;case"twirl-left":v(e,r,t,c,o,-1);break;case"twirl-right":v(e,r,t,c,o,1);break;case"pinch":b(e,r,t,c,o);break;case"bloat":h(e,r,t,c,o)}}),e.fabric.renderAll(),m.push({x:r,y:t,mode:a.warpMode})}}function u(a,e,r,t,n){var c=e-a.left,o=r-a.top,i=Math.sqrt(c*c+o*o);if(i<t){var f=(1-i/t)*n*5;a.left-=c*f*.01,a.top-=o*f*.01}}function p(a,e,r,t,n){var c=e-a.left,o=r-a.top,i=Math.sqrt(c*c+o*o);if(i<t){var f=(1-i/t)*n*5;a.left+=c*f*.01,a.top+=o*f*.01}}function v(a,e,r,t,n,c){var o=e-a.left,i=r-a.top,f=Math.sqrt(o*o+i*i);if(f<t){var l=(1-f/t)*n*c;a.angle=(a.angle||0)+.5*l}}function b(a,e,r,t,n){var c=e-a.left,o=r-a.top,i=Math.sqrt(c*c+o*o);if(i<t){var f=(1-i/t)*n,l=1-.01*f;a.scaleX=(a.scaleX||1)*l,a.scaleY=(a.scaleY||1)*l}}function h(a,e,r,t,n){var c=e-a.left,o=r-a.top,i=Math.sqrt(c*c+o*o);if(i<t){var f=(1-i/t)*n,l=1+.01*f;a.scaleX=(a.scaleX||1)*l,a.scaleY=(a.scaleY||1)*l}}a.warpActive=!1,a.warpMode="push",a.brushSize=50,a.brushStrength=30;var g=!1,m=[],d=null;a.startWarp=function(n){return e.currentImage()?(r.activePanel="warp",a.warpActive=!0,e.fabric.selection=!1,e.fabric.forEachObject(function(a){a.selectable=!1}),t(),void n.stopPropagation()):void alert("Please load an image first")},a.stopWarp=function(){a.warpActive=!1,r.activePanel=null,n(),e.fabric.selection=!0,e.fabric.forEachObject(function(a){a.selectable=!0})},a.applyWarp=function(){m.length>0&&e.history.add("warp",e.watermarkText,e.fabric),a.stopWarp(),m=[],d=null},a.cancelWarp=function(){d&&e.currentImage()&&o(),a.stopWarp(),m=[],d=null},a.setWarpMode=function(e){a.warpMode=e},a.resetWarp=function(){o(),m=[]}});